<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chicken ‚Äì Apple Fresh Farm Meats</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }

    .card {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }

    .card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 6px;
    }

    .price { font-weight: bold; margin: 8px 0; }

    button {
      padding: 6px 12px;
      background: green;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #cartBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: darkred;
    }

    #cartModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
    }

    #cartBox {
      background: white;
      width: 90%;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
      border-radius: 8px;
    }

    .cart-item {
      border-bottom: 1px solid #ddd;
      padding: 6px 0;
    }

    input, textarea {
      width: 100%;
      margin: 5px 0;
      padding: 6px;
    }
  </style>
</head>
<body>

<h1>üêî Chicken Products</h1>

<button id="cartBtn" onclick="openCart()">üõí Cart (<span id="cartCount">0</span>)</button>

<div class="grid" id="productGrid"></div>

<!-- CART MODAL -->
<div id="cartModal">
  <div id="cartBox">
    <h2>Your Order</h2>
    <div id="cartItems"></div>
    <h3>Total: ‚Çπ<span id="cartTotal">0</span></h3>

    <h3>Customer Details</h3>
    <input id="custName" placeholder="Name">
    <input id="custPhone" placeholder="Phone">
    <input id="custEmail" placeholder="Email">
    <textarea id="custAddress" placeholder="Address"></textarea>

    <button onclick="placeOrder()">Order via WhatsApp</button>
    <button onclick="closeCart()">Close</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzDKXX1UoJjt6IKDHOhWMKPvSUaZqeD1fXWqp6r9L3AiMDUf9RJXLOe-Yuo9mnTLYc/exec";
const CART_KEY = "applefarm_cart";

function getCart() {
  return JSON.parse(localStorage.getItem(CART_KEY)) || [];
}

function saveCart(cart) {
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
  updateCartCount();
}

function updateCartCount() {
  const cart = getCart();
  document.getElementById("cartCount").innerText =
    cart.reduce((s, i) => s + i.quantity, 0);
}

function addToCart(p) {
  let cart = getCart();
  let item = cart.find(i => i.product_id === p.product_id);

  if (item) item.quantity += 1;
  else cart.push({ ...p, quantity: 1 });

  saveCart(cart);
}

function openCart() {
  document.getElementById("cartModal").style.display = "block";
  renderCart();
}

function closeCart() {
  document.getElementById("cartModal").style.display = "none";
}

function renderCart() {
  const cart = getCart();
  let html = "";
  let total = 0;

  cart.forEach(i => {
    const amt = i.price * i.quantity;
    total += amt;
    html += `<div class="cart-item">
      ${i.product_name} √ó ${i.quantity} = ‚Çπ${amt}
    </div>`;
  });

  document.getElementById("cartItems").innerHTML = html || "Cart empty";
  document.getElementById("cartTotal").innerText = total;
}

async function placeOrder() {
  const cart = getCart();
  if (cart.length === 0) return alert("Cart is empty");

  const customer = {
    name: custName.value,
    phone: custPhone.value,
    email: custEmail.value,
    address: custAddress.value
  };

  if (!customer.name || !customer.phone)
    return alert("Name & phone required");

  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ customer, items: cart })
  });

  let msg = "Apple Fresh Farm Order%0A";
  cart.forEach(i => {
    msg += `${i.product_name} √ó ${i.quantity} = ‚Çπ${i.price*i.quantity}%0A`;
  });
  msg += `Total: ‚Çπ${cart.reduce((s,i)=>s+i.price*i.quantity,0)}`;

  // CLEAR CART AFTER ORDER ‚úÖ
  localStorage.removeItem(CART_KEY);
  updateCartCount();
  closeCart();

  window.open(`https://wa.me/91${customer.phone}?text=${msg}`, "_blank");
}

async function loadProducts() {
  const res = await fetch(API_URL + "?action=chicken");
  const data = await res.json();

  const grid = document.getElementById("productGrid");
  grid.innerHTML = "";

  data.forEach(p => {
    grid.innerHTML += `
      <div class="card">
        <img src="${p.product_image}">
        <h3>${p.product_name}</h3>
        <div class="price">‚Çπ${p.price}</div>
        <button onclick='addToCart(${JSON.stringify(p)})'>Add to Cart</button>
      </div>`;
  });
}

loadProducts();
updateCartCount();
</script>

</body>
</html>
